<div class="container mt-4 rounded-lg">

  <div class="flex items-center justify-between gap-4 mt-4 mb-4">
    <div class="relative">
      <lucide-icon name="search" class="w-4 h-4 absolute left-1 top-1/2 transform -translate-y-1/2 text-gray-400"></lucide-icon>
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearch()"
        placeholder="Filtrar profissionais"
        class="pl-7 pr-4 py-2 border border-gray-400 rounded-md focus:outline-none focus:ring-2 focus:ring-grey-900 focus:border-transparent"
        maxlength="20" />
    </div>

    <button (click)="onAddNovo()"
            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center gap-2">
      <lucide-icon name="plus" class="w-4 h-4"></lucide-icon>
      Novo
    </button>
  </div>

  @if (isLoading) {
    <div class="flex justify-center items-center h-32">
      <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary"></div>
    </div>
  } @else if (items.length === 0) {
    <div class="text-center py-8 w-full bg-white rounded-lg">
      <p class="text-gray-500">Nenhum profissional encontrado.</p>
    </div>
  } @else {
    <div class="overflow-x-auto rounded-lg">
      <table class="min-w-full table-auto">
        <thead class="text-white bg-blue-500">
        <tr>
          <th (click)="ordenar('nome')" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-auto cursor-pointer hover:bg-blue-600">
            <lucide-icon *ngIf="getSortIcon('nome')" [name]="getSortIcon('nome')" class="inline w-4 h-4"/>
            Nome
          </th>
          <th (click)="ordenar('email')" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-64 cursor-pointer hover:bg-blue-600">
            <lucide-icon *ngIf="getSortIcon('email')" [name]="getSortIcon('email')" class="inline ml-1 w-4 h-4"/>
            Email
          </th>
          <th (click)="ordenar('crm')" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-40 cursor-pointer hover:bg-blue-600">
            <lucide-icon *ngIf="getSortIcon('crm')" [name]="getSortIcon('crm')" class="inline ml-1 w-4 h-4"/>
            CRM
          </th>
          <th (click)="ordenar('celular')" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-40 cursor-pointer hover:bg-blue-600">
            <lucide-icon *ngIf="getSortIcon('celular')" [name]="getSortIcon('celular')" class="inline ml-1 w-4 h-4"/>
            Celular
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-28"></th>
        </tr>
        </thead>
        <tbody class="bg-white">
          @for (profissional of getItensPaginados(); track profissional.id) {
            <tr class="border-b hover:bg-gray-50 cursor-pointer" (click)="selecionar(profissional)">
              <td class="px-6 py-2 whitespace-nowrap">{{profissional.nome}}</td>
              <td class="px-6 py-2 whitespace-nowrap">{{profissional.email}}</td>
              <td class="px-6 py-2 whitespace-nowrap">{{profissional.crm}}</td>
              <td class="px-6 py-2 whitespace-nowrap">{{profissional.celular | celular}}</td>
              <td class="px-4 py-1 whitespace-nowrap w-28 text-right">
                <div>
                  <button
                    (click)="toggleDropdown($event, profissional.id)"
                    class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary" >
                    Ações
                    <lucide-icon name="chevron-down" class="ml-1 h-4 w-4" />
                  </button>
                  @if (dropdownAberto === profissional.id) {
                    <ng-template [ngTemplateOutlet]="acoesTemplate" [ngTemplateOutletContext]="{ profissional: profissional }"></ng-template>
                  }
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <app-pagination [items]="items" [totalPaginas]="totalPaginas" (pageChange)="pageChange($event)"></app-pagination>
  }

  @if (itemSelecionado) {
    <app-profissional-detalhes
      [profissional]="itemSelecionado"
      (fechou)="fecharDetalhes()"
    ></app-profissional-detalhes>
  }

  @if (mostrarFormularioNovo) {
    <app-profissional-form
      [profissional]="itemEdicao"
      (save)="onSalvarNovoProfissional($event)"
      (cancel)="onCancelarNovo()"
    ></app-profissional-form>
  }
</div>

<ng-template #acoesTemplate let-profissional="profissional">
  <div class="absolute rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-50">
    <div class="py-1 flex flex-col">
      <a
        (click)="handleAction($event, 'agendar', profissional)"
        class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer" >
        Agendar Consulta
      </a>
      <a
        (click)="handleAction($event, 'historico', profissional)"
        class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer" >
        Ver Histórico
      </a>
      <a
        (click)="editar($event, profissional)"
        class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer" >
        Editar
      </a>
      <a
        (click)="handleAction($event, 'excluir', profissional)"
        class="block px-4 py-2 text-sm text-red-700 hover:bg-red-50 cursor-pointer" >
        Excluir
      </a>
    </div>
  </div>
</ng-template>
