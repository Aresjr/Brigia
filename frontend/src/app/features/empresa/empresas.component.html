<div class="mt-4 rounded-lg">

  <app-top-bar (search)="onSearch($event)" (addNovo)="onAddNovo()" title="Empresas Parceiras"></app-top-bar>

    @if (isLoading) {
        <div class="flex justify-center items-center h-32">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary"></div>
        </div>
    } @else if (itensExibicao.length === 0) {
        <div class="text-center py-8 w-full bg-white rounded-lg">
            <p class="text-gray-500">Nenhum registro encontrado.</p>
        </div>
    } @else {
        <div class="overflow-x-auto rounded-lg">
            <table class="table-fixed w-full border-collapse text-sm">
                <thead class="text-white bg-blue-500">
                    <tr>
                        <th (click)="ordenar('nome')" class="px-5 py-1 text-left font-medium uppercase cursor-pointer hover:bg-blue-600 w-44" title="Nome da Empresa">
                            <lucide-icon *ngIf="getSortIcon('nome')" [name]="getSortIcon('nome')" class="absolute -ml-2 w-4 h-4"/>
                            Nome
                        </th>
                        <th (click)="ordenar('codigoBc')" class="px-4 py-1 text-left font-medium text-xs uppercase cursor-pointer hover:bg-blue-600 w-6" title="Código BC">
                          <lucide-icon *ngIf="getSortIcon('codigoBc')" [name]="getSortIcon('codigoBc')" class="absolute -ml-2 w-4 h-4"/>
                          Cód. BC
                        </th>
                        <th (click)="ordenar('valorMinimoMensal')" class="px-4 py-1 text-left font-medium text-xs uppercase cursor-pointer hover:bg-blue-600 w-6" title="Valor Mínimo Mensal">
                          <lucide-icon *ngIf="getSortIcon('valorMinimoMensal')" [name]="getSortIcon('valorMinimoMensal')" class="absolute -ml-2 w-4 h-4"/>
                          Mín. Mensal
                        </th>
                        <th (click)="ordenar('minimoPorFuncionario')" class="px-4 py-1 text-left font-medium text-xs uppercase overflow-hidden cursor-pointer hover:bg-blue-600 w-8" title="Valor Mínimo por Funcionário">
                          <lucide-icon *ngIf="getSortIcon('minimoPorFuncionario')" [name]="getSortIcon('minimoPorFuncionario')" class="absolute -ml-2 w-4 h-4"/>
                          Mín. Por Funcionário
                        </th>
                        <th (click)="ordenar('valorMes')" class="px-4 py-1 text-left font-medium text-xs uppercase cursor-pointer hover:bg-blue-600 w-2" title="Valor Mínimo por Mês">
                          <lucide-icon *ngIf="getSortIcon('valorMes')" [name]="getSortIcon('valorMes')" class="absolute -ml-2 w-4 h-4"/>
                          Valor Mês
                        </th>
                        <th (click)="ordenar('observacao')" class="px-4 py-1 text-left font-medium uppercase cursor-pointer hover:bg-blue-600 w-36" title="Descrição / Observações">
                            <lucide-icon *ngIf="getSortIcon('observacao')" [name]="getSortIcon('observacao')" class="absolute -ml-2 w-4 h-4"/>
                            Observações
                        </th>
                        <th class="w-4 text-right">
                           <lucide-icon name="ellipsis-vertical" class="h-5" />
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white">
                    @for (empresa of getItensPaginados(); track empresa.id) {
                        <tr class="border-b hover:bg-gray-100" [class.bg-red-50]="empresa.excluido" [ngClass]="empresa.plano?.corFundo" >
                            <td class="px-4 py-2 whitespace-nowrap w-44">
                                {{empresa.nome}} <span *ngIf="empresa.excluido" class="ml-2 px-2 py-1 text-xs bg-red-100 text-red-800 rounded">Excluído</span>
                            </td>
                            <td class="px-4 py-2 w-6">{{empresa.codigoBc}}</td>
                            <td class="px-4 py-2 w-6">{{empresa.valorMinimoMensal}}</td>
                            <td class="px-4 py-2 w-12">{{empresa.minimoPorFuncionario}}</td>
                            <td class="px-4 py-2 w-2">{{empresa.valorMes}}</td>
                            <td class="px-4 text-xs">{{empresa.observacao}}</td>
                            <td class="px-4 whitespace-nowrap w-36 text-right" >
                                <div>
                                    <button
                                        (click)="toggleDropdown($event, empresa.id)"
                                        class="inline-flex items-center py-1 border border-gray-300 text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary" >
                                      <lucide-icon name="ellipsis-vertical" class="h-4 w-4" />
                                    </button>
                                    @if (dropdownAberto === empresa.id) {
                                        <div class="absolute rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-50">
                                            <div class="py-1 flex flex-col">
                                                <a *ngIf="!empresa.excluido"
                                                    (click)="editar($event, empresa)"
                                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
                                                    Editar
                                                </a>
                                                <a *ngIf="!empresa.excluido"
                                                    (click)="perguntaExcluir($event, empresa)"
                                                    class="block px-4 py-2 text-sm text-red-700 hover:bg-red-50 cursor-pointer">
                                                    Excluir
                                                </a>
                                                <a *ngIf="empresa.excluido"
                                                    (click)="restaurarItem($event, empresa)"
                                                    class="block px-4 py-2 text-sm text-green-700 hover:bg-green-50 cursor-pointer">
                                                    Restaurar
                                                </a>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <app-pagination [items]="itensExibicao" [totalPaginas]="totalPaginas" (pageChange)="pageChange($event)"></app-pagination>
    }

  @if (mostrarFormularioNovo) {
    <app-empresa-form
      [empresa]="itemEdicao"
      (save)="onSalvarNovoEmpresa($event)"
      (cancel)="onCancelarNovo()"
    ></app-empresa-form>
  }

  <app-confirm-dialog
    *ngIf="exibeConfirmExclusao"
    title="Excluir {{this.nomeEntidade}}"
    message="Deseja realmente excluir este registro?"
    (confirm)="excluir()"
    (cancel)="fecharConfirmExclusao()"
  ></app-confirm-dialog>

</div>
