<div class="mt-4">

  <app-top-bar title="Contas a Receber"></app-top-bar>

  @if (isLoading) {
    <app-loading-spinner></app-loading-spinner>
  } @else {

    <!-- Botão para expandir/recolher filtros -->
    <div class="mb-3">
      <button type="button" class="btn btn-sm btn-ghost" (click)="toggleFiltros()">
        <lucide-icon [name]="mostrarFiltros ? 'chevron-up' : 'chevron-down'" class="inline w-4 h-4 mr-2"></lucide-icon>
        {{ mostrarFiltros ? 'Ocultar Filtros' : 'Mostrar Filtros' }}
      </button>
    </div>

    @if (mostrarFiltros) {
      <form [formGroup]="form" class="flex flex-wrap gap-2 mb-2">
          <div class="min-w-80 px-6 py-2.5">
            <label class="label-campo tooltip text-left w-full" data-tip="Filtrar Status">
              Status
              <ng-select formControlName="status" class="campo-select w-full" placeholder="Todos">
                <ng-option class="max-h-8" value="">Todos</ng-option>
                @for (status of StatusContaReceber | keyvalue; track status) {
                  <ng-option class="max-h-8" value="{{ status.key }}">{{ status.value.descricao }}</ng-option>
                }
                <ng-template ng-notfound-tmp>
                  <span class="text-sm p-6">Nenhum resultado</span>
                </ng-template>
              </ng-select>
            </label>
          </div>
          <div class="min-w-80 px-6 py-2.5">
            <label class="label-campo tooltip text-left w-full" data-tip="Filtrar Paciente">
              Paciente
              <ng-select formControlName="paciente" class="campo-select w-full" placeholder="Todos">
                <ng-option class="max-h-8" value="">Todos</ng-option>
                @for (paciente of pacientes; track paciente.id) {
                  <ng-option class="max-h-8" value="{{ paciente.id }}">{{ paciente.nome }}</ng-option>
                }
                <ng-template ng-notfound-tmp>
                  <span class="text-sm p-6">Nenhum resultado</span>
                </ng-template>
              </ng-select>
            </label>
          </div>
          <div class="min-w-80 px-6 py-2.5">
            <label class="label-campo tooltip text-left w-full" data-tip="Filtrar Empresa">
              Empresa
              <ng-select formControlName="empresa" class="campo-select w-full" placeholder="Todos">
                <ng-option class="max-h-8" value="">Todos</ng-option>
                @for (empresa of empresas; track empresa.id) {
                  <ng-option class="max-h-8" value="{{ empresa.id }}">{{ empresa.nome }}</ng-option>
                }
                <ng-template ng-notfound-tmp>
                  <span class="text-sm p-6">Nenhum resultado</span>
                </ng-template>
              </ng-select>
            </label>
          </div>
          <div class="min-w-80 px-6 py-2.5">
            <label class="label-campo tooltip text-left w-full" data-tip="Filtrar Profissional">
              Profissional
              <ng-select formControlName="profissional" class="campo-select w-full" placeholder="Todos">
                <ng-option class="max-h-8" value="">Todos</ng-option>
                @for (profissional of profissionais; track profissional.id) {
                  <ng-option class="max-h-8" value="{{ profissional.id }}">{{ profissional.nome }}</ng-option>
                }
                <ng-template ng-notfound-tmp>
                  <span class="text-sm p-6">Nenhum resultado</span>
                </ng-template>
              </ng-select>
            </label>
          </div>
          <div class="min-w-80 px-6 py-2.5">
            <label class="label-campo tooltip text-left w-full" data-tip="Filtrar Forma de Pagamento">
              Forma de Pagamento
              <ng-select formControlName="formaPagamento" class="campo-select w-full" placeholder="Todos">
                <ng-option class="max-h-8" value="">Todos</ng-option>
                @for (formaPagamento of formasPagamento; track formaPagamento.valor) {
                  <ng-option class="max-h-8" value="{{ formaPagamento.valor }}">{{ formaPagamento.descricao }}</ng-option>
                }
                <ng-template ng-notfound-tmp>
                  <span class="text-sm p-6">Nenhum resultado</span>
                </ng-template>
              </ng-select>
            </label>
          </div>
          <div class="min-w-96 px-6 py-2.5">
            <label class="label-campo w-full">
              Data do Agendamento
              <div class="flex items-center gap-2">
                <div class="tooltip text-left" data-tip="Data Início">
                  <input #dataInicio type="date" class="campo w-[9.5rem]" formControlName="dataInicio" />
                  <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2" (click)="abrirDatePicker(dataInicio)">
                    <lucide-icon name="calendar" class="inline h-4"/>
                  </button>
                </div>
                <span class="text-sm">-</span>
                <div class="tooltip text-left" data-tip="Data Fim">
                  <div class="relative">
                    <input #dataFim type="date" class="campo w-[9.5rem]" formControlName="dataFim" />
                    <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2" (click)="abrirDatePicker(dataFim)">
                      <lucide-icon name="calendar" class="inline h-4"/>
                    </button>
                  </div>
                </div>
              </div>
            </label>
          </div>
      </form>
    }

  @if(itensExibicao.length == 0) {
    <div class="text-center py-8 w-full bg-base-100 rounded-lg shadow-md">
      <p>Nenhum registro encontrado.</p>
    </div>
  } @else {

    <!-- Dropdown de Ações -->
    @if(algumSelecionado()) {
      <div class="mb-3 flex items-center gap-3 px-2">
        <span class="text-sm font-medium">{{ itensSelecionados.size }} item(ns) selecionado(s)</span>
        <div class="dropdown">
          <button tabindex="0" class="btn btn-sm btn-primary" (click)="mostrarDropdownAcoes = !mostrarDropdownAcoes">
            Ações
            <lucide-icon name="chevron-down" class="inline w-4 h-4 ml-1"></lucide-icon>
          </button>
          @if(mostrarDropdownAcoes) {
            <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow-lg border border-base-300">
              <li>
                <button
                  [disabled]="!podeGerarPDF()"
                  [class.disabled]="!podeGerarPDF()"
                  [class.tooltip]="!podeGerarPDF()"
                  [attr.data-tip]="!podeGerarPDF() ? 'Selecione uma empresa ou paciente no filtro' : ''"
                  (click)="gerarPDF()">
                  <lucide-icon name="file-text" class="inline w-4 h-4"></lucide-icon>
                  Gerar PDF
                </button>
              </li>
            </ul>
          }
        </div>
      </div>
    }

    <div class="min-h-[36rem]">
      <div class="titulo-listagem grid-cols-[3rem_1fr_1fr_1fr_1fr_1fr_1fr]">
        <div class="cabecalho-listagem rounded-tl-lg flex items-center justify-center">
          <input
            type="checkbox"
            class="checkbox checkbox-sm"
            [checked]="todosSelecionados()"
            (change)="toggleSelecaoTodos($event)">
        </div>
        <div (click)="ordenar('status')" class="cabecalho-listagem whitespace-nowrap">
          <lucide-icon *ngIf="getSortIcon('status')" [name]="getSortIcon('status')" class="icone-ordenacao"/>
          Status
        </div>
        <div (click)="ordenar('paciente')" class="cabecalho-listagem whitespace-nowrap">
          <lucide-icon *ngIf="getSortIcon('paciente')" [name]="getSortIcon('paciente')" class="icone-ordenacao"/>
          Paciente
        </div>
        <div (click)="ordenar('empresa')" class="cabecalho-listagem whitespace-nowrap">
          <lucide-icon *ngIf="getSortIcon('empresa')" [name]="getSortIcon('empresa')" class="icone-ordenacao"/>
          Empresa
        </div>
        <div (click)="ordenar('profissional')" class="cabecalho-listagem whitespace-nowrap">
          <lucide-icon *ngIf="getSortIcon('profissional')" [name]="getSortIcon('profissional')" class="icone-ordenacao"/>
          Profissional
        </div>
        <div (click)="ordenar('formaPagamento')" class="cabecalho-listagem whitespace-nowrap">
          <lucide-icon *ngIf="getSortIcon('formaPagamento')" [name]="getSortIcon('formaPagamento')" class="icone-ordenacao"/>
          Forma de Pagamento
        </div>
        <div (click)="ordenar('dataAgendamento')" class="cabecalho-listagem rounded-tr-lg whitespace-nowrap">
          <lucide-icon *ngIf="getSortIcon('dataAgendamento')" [name]="getSortIcon('dataAgendamento')" class="icone-ordenacao"/>
          Data Agendamento
        </div>
      </div>

      <div class="itens-listagem">
        @for (contaReceber of getItensPaginados(); track contaReceber.id) {
          <div class="item-listagem grid-cols-[3rem_1fr_1fr_1fr_1fr_1fr_1fr]">
            <div class="celula-listagem flex items-center justify-center">
              <input
                type="checkbox"
                class="checkbox checkbox-sm"
                [checked]="isSelecionado(contaReceber.id)"
                (click)="toggleSelecao(contaReceber.id, $event)">
            </div>
            <div class="celula-listagem flex items-center px-4 py-1.5" (click)="selecionar(contaReceber)">
              <div class="badge text-base-100" [ngClass]="'bg-['+ StatusContaReceber[contaReceber.status].cor +']'">
                {{ StatusContaReceber[contaReceber.status].descricao }}
              </div>
            </div>
            <div class="celula-listagem" (click)="selecionar(contaReceber)">{{contaReceber.paciente.nome}}</div>
            <div class="celula-listagem" (click)="selecionar(contaReceber)">{{contaReceber.empresa?.nome}}</div>
            <div class="celula-listagem" (click)="selecionar(contaReceber)">{{contaReceber.profissional.nome}}</div>
            <div class="celula-listagem" (click)="selecionar(contaReceber)">{{ getFormaPagamentoDescricao(contaReceber.formaPagamento) }}</div>
            <div class="celula-listagem" (click)="selecionar(contaReceber)">{{contaReceber.dataAgendamento | date:'dd/MM/yyyy'}}</div>
          </div>
        }
      </div>
    </div>

    <app-pagination [items]="itensExibicao" [totalPaginas]="totalPaginas" (pageChange)="pageChange($event)"></app-pagination>
  }

}

  @if(mostrarDetalhes && itemSelecionado) {
    <app-contas-receber-detalhes
      [contaReceber]="itemSelecionado"
      (fechou)="fecharDetalhesContaReceber($event)">
    </app-contas-receber-detalhes>
  }

</div>
