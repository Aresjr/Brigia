<div class="fixed inset-0 flex items-center justify-center bg-black/50 z-50 text-sm">
  <div class="bg-base-100 rounded-lg shadow-lg p-6 w-[62rem]"
       (click)="$event.stopPropagation()" >

    <div class="flex justify-between items-center">
      <div class="flex items-center gap-4 justify-between">
        <h2 class="text-lg font-semibold">{{ titulo }}</h2>
        <div *ngIf="atendimentoDetalhes" class="badge font-semibold p-3 text-base-100"
             [ngClass]="'bg-['+ StatusAtendimento[atendimentoDetalhes.status].cor +']'">
          {{ StatusAtendimento[atendimentoDetalhes.status].descricao }}
        </div>
        <div *ngIf="atendimentoDetalhes && atendimentoDetalhes.status == 2">
          <div class="font-semibold text-lg">
            {{ atendimentoDetalhes.data | date:'dd/MM/yyyy' }}
          </div>
        </div>
        <div *ngIf="atendimentoDetalhes && atendimentoDetalhes.status == 2">
          {{ atendimentoDetalhes.horaInicio }} - {{ atendimentoDetalhes.horaFim }}
        </div>
      </div>

      <div class="flex gap-2 items-center">
        <!-- Botão de Impressão -->
        <div *ngIf="atendimentoDetalhes && atendimentoDetalhes.status == 2" class="dropdown dropdown-end print:hidden">
          <button tabindex="0" type="button" class="btn btn-sm btn-ghost btn-circle"
                  (click)="mostrarDropdownImpressao = !mostrarDropdownImpressao"
                  title="Imprimir">
            <lucide-icon name="printer" class="inline w-5 h-5"/>
          </button>
          @if(mostrarDropdownImpressao) {
            <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow-lg border border-base-300 mt-2">
              <li>
                <button type="button" (click)="imprimirAtendimento('padrao')">
                  <lucide-icon name="file-text" class="inline w-4 h-4"></lucide-icon>
                  Modo Padrão
                </button>
              </li>
              <li>
                <button type="button" (click)="imprimirAtendimento('alternativo')">
                  <lucide-icon name="file-text" class="inline w-4 h-4"></lucide-icon>
                  Modo Alternativo
                </button>
              </li>
            </ul>
          }
        </div>

        <button type="button" class="btn btn-sm btn-ghost btn-circle print:hidden" (click)="fechar()" title="Fechar">
          <lucide-icon name="x" class="inline w-5 h-5"/>
        </button>
      </div>
    </div>

    <!-- Informações do Paciente -->
    <div *ngIf="agendamento" class="my-4 mx-0 p-4 bg-base-200 rounded-lg">
      <div class="grid grid-cols-4 gap-2">
        <div>
          <p class="text-xs text-neutral font-medium">Paciente</p>
          <p class="font-semibold">{{ agendamento.paciente.nome }}</p>
        </div>
        <div>
          <p class="text-xs text-neutral font-medium">Data de Nascimento</p>
          <p class="font-semibold">{{ agendamento.paciente.dataNascimento | date:'dd/MM/yyyy' }}</p>
        </div>
        <div>
          <p class="text-xs text-neutral font-medium">Convênio</p>
          <p class="font-semibold">{{ agendamento.convenio?.nome || 'Particular' }}</p>
        </div>
        <div>
          <p class="text-xs text-neutral font-medium">Última Consulta</p>
          <p class="font-semibold">{{ agendamento.paciente.ultimaConsulta | date:'dd/MM/yyyy' }}</p>
        </div>
      </div>
    </div>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="mt-2" [ngClass]="{ 'visualizacao': readonly }">

      <div class="inline-flex rounded-lg border border-base-300 p-1 mb-1">
        <button type="button"
          (click)="selecionarAba('anamnese')"
          class="btn btn-sm"
          [class]="abaAtiva === 'anamnese'
            ? 'btn-primary text-white px-4 py-2 rounded-md transition-all duration-200 font-medium'
            : 'btn-ghost text-gray-600 px-4 py-2 rounded-md transition-all duration-200 hover:bg-base-300'">
          Anamnese
        </button>
        <button type="button"
          (click)="selecionarAba('exameFisico')"
          class="btn btn-sm"
          [class]="abaAtiva === 'exameFisico'
            ? 'btn-primary text-white px-4 py-2 rounded-md transition-all duration-200 font-medium'
            : 'btn-ghost text-gray-600 px-4 py-2 rounded-md transition-all duration-200 hover:bg-base-300'">
          Exame Físico
        </button>
        <button type="button"
          (click)="selecionarAba('diagnostico')"
          class="btn btn-sm"
          [class]="abaAtiva === 'diagnostico'
            ? 'btn-primary text-white px-4 py-2 rounded-md transition-all duration-200 font-medium'
            : 'btn-ghost text-gray-600 px-4 py-2 rounded-md transition-all duration-200 hover:bg-base-300'">
          Diagnóstico
        </button>
        <button type="button"
          (click)="selecionarAba('evolucaoClinica')"
          class="btn btn-sm"
          [class]="abaAtiva === 'evolucaoClinica'
            ? 'btn-primary text-white px-4 py-2 rounded-md transition-all duration-200 font-medium'
            : 'btn-ghost text-gray-600 px-4 py-2 rounded-md transition-all duration-200 hover:bg-base-300'">
          Evolução Clínica
        </button>
        <button type="button"
          (click)="selecionarAba('examesSolicitados')"
          class="btn btn-sm"
          [class]="abaAtiva === 'examesSolicitados'
            ? 'btn-primary text-white px-4 py-2 rounded-md transition-all duration-200 font-medium'
            : 'btn-ghost text-gray-600 px-4 py-2 rounded-md transition-all duration-200 hover:bg-base-300'">
          Exames Solicitados
        </button>
        <button type="button"
          (click)="selecionarAba('prescricoes')"
          class="btn btn-sm"
          [class]="abaAtiva === 'prescricoes'
            ? 'btn-primary text-white px-4 py-2 rounded-md transition-all duration-200 font-medium'
            : 'btn-ghost text-gray-600 px-4 py-2 rounded-md transition-all duration-200 hover:bg-base-300'">
          Prescrições
        </button>
        <button type="button"
          (click)="selecionarAba('observacoes')"
          class="btn btn-sm"
          [class]="abaAtiva === 'observacoes'
            ? 'btn-primary text-white px-4 py-2 rounded-md transition-all duration-200 font-medium'
            : 'btn-ghost text-gray-600 px-4 py-2 rounded-md transition-all duration-200 hover:bg-base-300'">
          Observações
        </button>
      </div>

      <div>
        <div *ngIf="abaAtiva === 'anamnese'" class="quill-editor w-full border-0">
          <quill-editor
            formControlName="anamnese"
            class="w-full"
            [modules]="readonly ? {} : quillModules"
            [styles]="{ height: '200px' }"
            [readOnly]="readonly"
            placeholder="">
          </quill-editor>
        </div>
        <div *ngIf="abaAtiva === 'exameFisico'" class="quill-editor w-full border-0">
          <quill-editor
            formControlName="exameFisico"
            class="w-full"
            [modules]="readonly ? {} : quillModules"
            [styles]="{ height: '200px' }"
            [readOnly]="readonly"
            placeholder="">
          </quill-editor>
        </div>
        <div *ngIf="abaAtiva === 'diagnostico'" class="quill-editor w-full border-0">
          <quill-editor
            formControlName="diagnostico"
            class="w-full"
            [modules]="readonly ? {} : quillModules"
            [styles]="{ height: '200px' }"
            [readOnly]="readonly"
            placeholder="">
          </quill-editor>
        </div>
        <div *ngIf="abaAtiva === 'evolucaoClinica'" class="quill-editor w-full border-0">
          <quill-editor
            formControlName="evolucaoClinica"
            class="w-full"
            [modules]="readonly ? {} : quillModules"
            [styles]="{ height: '200px' }"
            [readOnly]="readonly"
            placeholder="">
          </quill-editor>
        </div>
        <div *ngIf="abaAtiva === 'examesSolicitados'" class="quill-editor w-full border-0">
          <quill-editor
            formControlName="examesSolicitados"
            class="w-full"
            [modules]="readonly ? {} : quillModules"
            [styles]="{ height: '200px' }"
            [readOnly]="readonly"
            placeholder="">
          </quill-editor>
        </div>
        <div *ngIf="abaAtiva === 'prescricoes'" class="quill-editor w-full border-0">
          <quill-editor
            formControlName="prescricoes"
            class="w-full"
            [modules]="readonly ? {} : quillModules"
            [styles]="{ height: '200px' }"
            [readOnly]="readonly"
            placeholder="">
          </quill-editor>
        </div>
        <div *ngIf="abaAtiva === 'observacoes'" class="quill-editor w-full border-0">
          <quill-editor
            formControlName="observacoes"
            class="w-full"
            [modules]="readonly ? {} : quillModules"
            [styles]="{ height: '200px' }"
            [readOnly]="readonly"
            placeholder="">
          </quill-editor>
        </div>
      </div>

      <div class="flex mt-2">
        <div class="w-full">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-lg font-medium">Procedimentos Adicionais</h3>
          </div>

          <div class="rounded-t-lg">
            <div class="grid grid-cols-[3rem_1fr] gap-3 p-3 font-medium">
              <div>Qtd.</div>
              <div>Procedimento</div>
            </div>
          </div>

          <div class="space-y-1" formArrayName="procedimentos">
            <div *ngFor="let procedimento of procedimentosLancados.controls; let i = index" [formGroupName]="i"
                 class="grid grid-cols-[3rem_1fr] gap-3 items-center hover:bg-base-200 rounded-lg">

              <input [id]="'quantidade_' + i" type="number" min="1" formControlName="quantidade" class="campo mt-0 p-2" readonly>

              <ng-select [id]="'procedimento_' + i"  class="campo-select mt-0"
                         formControlName="procedimentoId"
                         placeholder="Selecione um procedimento"
                         [readonly]="true">
                @for (procedimento of procedimentos; track procedimento.id) {
                  <ng-option [value]="procedimento.id">{{procedimento.nome}}</ng-option>
                }
                <ng-template ng-notfound-tmp>
                  <span class="text-sm p-6">Nenhum resultado</span>
                </ng-template>
              </ng-select>
            </div>
          </div>
        </div>
      </div>

      <div class="flex justify-between mt-6">
        <button type="button" class="btn btn-sm" (click)="fechar()" >
          Fechar
        </button>
        <div>
          <button type="button" class="btn btn-primary btn-sm" *ngIf="podeEditar()" (click)="habilitarEdicao()">
            Continuar Atendimento
          </button>
          <button type="submit" class="btn btn-success btn-sm" *ngIf="modoSalvar">
            Finalizar Atendimento
          </button>
        </div>
      </div>
    </form>

  </div>
</div>

<!-- Layout de Impressão Modo Padrão -->
<div *ngIf="modoImpressao === 'padrao'" class="print-content print-modo-padrao">
  <div class="print-header">
    <h1>Registro de Atendimento Médico</h1>
    <p class="print-subtitle">Modo Padrão</p>
  </div>

  <div class="print-section">
    <h2>Informações do Paciente</h2>
    <div class="print-grid">
      <div class="print-field">
        <span class="print-label">Nome:</span>
        <span class="print-value">{{ agendamento?.paciente?.nome }}</span>
      </div>
      <div class="print-field">
        <span class="print-label">Data de Nascimento:</span>
        <span class="print-value">{{ agendamento?.paciente?.dataNascimento | date:'dd/MM/yyyy' }}</span>
      </div>
      <div class="print-field">
        <span class="print-label">Convênio:</span>
        <span class="print-value">{{ agendamento?.convenio?.nome || 'Particular' }}</span>
      </div>
      <div class="print-field">
        <span class="print-label">Data do Atendimento:</span>
        <span class="print-value">{{ atendimentoDetalhes?.data | date:'dd/MM/yyyy' }}</span>
      </div>
      <div class="print-field">
        <span class="print-label">Horário:</span>
        <span class="print-value">{{ atendimentoDetalhes?.horaInicio }} - {{ atendimentoDetalhes?.horaFim }}</span>
      </div>
    </div>
  </div>

  <div class="print-section" *ngIf="form.get('anamnese')?.value">
    <h2>Anamnese</h2>
    <div class="print-content-html" [innerHTML]="form.get('anamnese')?.value"></div>
  </div>

  <div class="print-section" *ngIf="form.get('exameFisico')?.value">
    <h2>Exame Físico</h2>
    <div class="print-content-html" [innerHTML]="form.get('exameFisico')?.value"></div>
  </div>

  <div class="print-section" *ngIf="form.get('diagnostico')?.value">
    <h2>Diagnóstico</h2>
    <div class="print-content-html" [innerHTML]="form.get('diagnostico')?.value"></div>
  </div>

  <div class="print-section" *ngIf="form.get('evolucaoClinica')?.value">
    <h2>Evolução Clínica</h2>
    <div class="print-content-html" [innerHTML]="form.get('evolucaoClinica')?.value"></div>
  </div>

  <div class="print-section" *ngIf="form.get('examesSolicitados')?.value">
    <h2>Exames Solicitados</h2>
    <div class="print-content-html" [innerHTML]="form.get('examesSolicitados')?.value"></div>
  </div>

  <div class="print-section" *ngIf="form.get('prescricoes')?.value">
    <h2>Prescrições</h2>
    <div class="print-content-html" [innerHTML]="form.get('prescricoes')?.value"></div>
  </div>

  <div class="print-section" *ngIf="form.get('observacoes')?.value">
    <h2>Observações</h2>
    <div class="print-content-html" [innerHTML]="form.get('observacoes')?.value"></div>
  </div>

  <div class="print-footer">
    <p>Documento gerado em {{ 'now' | date:'dd/MM/yyyy HH:mm' }}</p>
  </div>
</div>

<!-- Layout de Impressão Modo Alternativo -->
<div *ngIf="modoImpressao === 'alternativo'" class="print-content print-modo-alternativo">
  <div class="print-header-alt">
    <div class="print-header-left">
      <h1>Atendimento Médico</h1>
      <p class="print-date">{{ atendimentoDetalhes?.data | date:'dd/MM/yyyy' }} - {{ atendimentoDetalhes?.horaInicio }}</p>
    </div>
    <div class="print-header-right">
      <p class="print-label-alt">Modo Alternativo</p>
    </div>
  </div>

  <div class="print-patient-box">
    <div class="print-patient-row">
      <div class="print-patient-field">
        <strong>Paciente:</strong> {{ agendamento?.paciente?.nome }}
      </div>
      <div class="print-patient-field">
        <strong>DN:</strong> {{ agendamento?.paciente?.dataNascimento | date:'dd/MM/yyyy' }}
      </div>
    </div>
    <div class="print-patient-row">
      <div class="print-patient-field">
        <strong>Convênio:</strong> {{ agendamento?.convenio?.nome || 'Particular' }}
      </div>
      <div class="print-patient-field">
        <strong>Horário:</strong> {{ atendimentoDetalhes?.horaInicio }} - {{ atendimentoDetalhes?.horaFim }}
      </div>
    </div>
  </div>

  <div class="print-section-alt" *ngIf="form.get('anamnese')?.value">
    <h3>Anamnese</h3>
    <div class="print-content-html-alt" [innerHTML]="form.get('anamnese')?.value"></div>
  </div>

  <div class="print-section-alt" *ngIf="form.get('exameFisico')?.value">
    <h3>Exame Físico</h3>
    <div class="print-content-html-alt" [innerHTML]="form.get('exameFisico')?.value"></div>
  </div>

  <div class="print-section-alt" *ngIf="form.get('diagnostico')?.value">
    <h3>Diagnóstico</h3>
    <div class="print-content-html-alt" [innerHTML]="form.get('diagnostico')?.value"></div>
  </div>

  <div class="print-section-alt" *ngIf="form.get('evolucaoClinica')?.value">
    <h3>Evolução Clínica</h3>
    <div class="print-content-html-alt" [innerHTML]="form.get('evolucaoClinica')?.value"></div>
  </div>

  <div class="print-section-alt" *ngIf="form.get('examesSolicitados')?.value">
    <h3>Exames Solicitados</h3>
    <div class="print-content-html-alt" [innerHTML]="form.get('examesSolicitados')?.value"></div>
  </div>

  <div class="print-section-alt" *ngIf="form.get('prescricoes')?.value">
    <h3>Prescrições</h3>
    <div class="print-content-html-alt" [innerHTML]="form.get('prescricoes')?.value"></div>
  </div>

  <div class="print-section-alt" *ngIf="form.get('observacoes')?.value">
    <h3>Observações</h3>
    <div class="print-content-html-alt" [innerHTML]="form.get('observacoes')?.value"></div>
  </div>

  <div class="print-footer-alt">
    <hr/>
    <p>Gerado em {{ 'now' | date:'dd/MM/yyyy HH:mm' }}</p>
  </div>
</div>

<app-confirm-dialog
  *ngIf="exibeConfirmCancelamento"
  message="Você já preencheu algumas informações do atendimento, deseja realmente sair?"
  (confirm)="fechar(true)"
  (cancel)="exibeConfirmCancelamento = false"
></app-confirm-dialog>
