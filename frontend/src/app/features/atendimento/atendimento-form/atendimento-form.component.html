<div class="fixed inset-0 flex items-center justify-center bg-black/50 z-50 text-sm">
  <div class="bg-base-100 rounded-lg shadow-lg p-6 w-[62rem]"
       (click)="$event.stopPropagation()" >

    <div class="flex justify-between items-center">
      <div class="flex items-center gap-4 justify-between">
        <h2 class="text-lg font-semibold">{{ titulo }}</h2>
        <div *ngIf="atendimentoDetalhes" class="badge font-semibold p-3 text-base-100"
             [ngClass]="'bg-['+ StatusAtendimento[atendimentoDetalhes.status].cor +']'">
          {{ StatusAtendimento[atendimentoDetalhes.status].descricao }}
        </div>
        <div *ngIf="atendimentoDetalhes && atendimentoDetalhes.status == 2">
          <div class="font-semibold text-lg">
            {{ atendimentoDetalhes.data | date:'dd/MM/yyyy' }}
          </div>
        </div>
        <div *ngIf="atendimentoDetalhes && atendimentoDetalhes.status == 2">
          {{ atendimentoDetalhes.horaInicio }} - {{ atendimentoDetalhes.horaFim }}
        </div>
      </div>

      <div class="flex gap-2 items-center">
        <!-- Botão de Impressão -->
        <div *ngIf="atendimentoDetalhes && atendimentoDetalhes.status == 2" class="dropdown dropdown-end print:hidden">
          <button tabindex="0" type="button" class="btn btn-sm btn-ghost btn-circle"
                  (click)="mostrarDropdownImpressao = !mostrarDropdownImpressao"
                  title="Imprimir">
            <lucide-icon name="printer" class="inline w-5 h-5"/>
          </button>
          @if(mostrarDropdownImpressao) {
            <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow-lg border border-base-300 mt-2">
              <li>
                <button type="button" (click)="imprimirAtendimento('padrao')">
                  <lucide-icon name="file-text" class="inline w-4 h-4"></lucide-icon>
                  Modo Padrão
                </button>
              </li>
              <li>
                <button type="button" (click)="imprimirAtendimento('alternativo')">
                  <lucide-icon name="file-text" class="inline w-4 h-4"></lucide-icon>
                  Modo Alternativo
                </button>
              </li>
            </ul>
          }
        </div>

        <button type="button" class="btn btn-sm btn-ghost btn-circle print:hidden" (click)="fechar()" title="Fechar">
          <lucide-icon name="x" class="inline w-5 h-5"/>
        </button>
      </div>
    </div>

    <!-- Informações do Paciente com Abas -->
    <div *ngIf="agendamento" class="my-4 mx-0 bg-base-200 rounded-lg">
      <!-- Abas -->
      <div class="flex border-b border-base-300">
        <button type="button"
          (click)="selecionarAbaPaciente('informacoes')"
          class="px-4 py-2 text-sm font-medium transition-colors"
          [class]="abaPacienteAtiva === 'informacoes'
            ? 'border-b-2 border-primary text-primary bg-base-100'
            : 'text-neutral hover:text-base-content'">
          <lucide-icon name="user" class="inline w-4 h-4 mr-1"></lucide-icon>
          Informações do Paciente
        </button>
        <button type="button"
          (click)="selecionarAbaPaciente('historico')"
          class="px-4 py-2 text-sm font-medium transition-colors"
          [class]="abaPacienteAtiva === 'historico'
            ? 'border-b-2 border-primary text-primary bg-base-100'
            : 'text-neutral hover:text-base-content'">
          <lucide-icon name="history" class="inline w-4 h-4 mr-1"></lucide-icon>
          Atendimentos Anteriores
          @if (atendimentosAnteriores.length > 0) {
            <span class="ml-1 badge badge-primary badge-xs">{{ atendimentosAnteriores.length }}</span>
          }
        </button>
      </div>

      <!-- Conteúdo das Abas -->
      <div class="p-4">
        <!-- Aba de Informações -->
        @if (abaPacienteAtiva === 'informacoes') {
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <p class="text-xs text-neutral font-medium">Paciente</p>
              <p class="font-semibold">{{ agendamento.paciente.nome }}</p>
            </div>
            <div>
              <p class="text-xs text-neutral font-medium">Data de Nascimento</p>
              <p class="font-semibold">
                {{ agendamento.paciente.dataNascimento | date:'dd/MM/yyyy' }}
                <span class="text-xs text-neutral ml-1">({{ calcularIdade(agendamento.paciente.dataNascimento) }} anos)</span>
              </p>
            </div>
            <div>
              <p class="text-xs text-neutral font-medium">Convênio</p>
              <p class="font-semibold">{{ agendamento.convenio?.nome || 'Particular' }}</p>
            </div>
            <div>
              <p class="text-xs text-neutral font-medium">Última Consulta</p>
              <p class="font-semibold">{{ agendamento.paciente.ultimaConsulta ? (agendamento.paciente.ultimaConsulta | date:'dd/MM/yyyy') : 'Nenhuma' }}</p>
            </div>
          </div>
        }

        <!-- Aba de Atendimentos Anteriores -->
        @if (abaPacienteAtiva === 'historico') {
          @if (carregandoAtendimentos) {
            <div class="flex justify-center items-center py-4">
              <span class="loading loading-spinner loading-md"></span>
            </div>
          } @else if (atendimentosAnteriores.length === 0) {
            <div class="text-center py-4 text-neutral">
              <lucide-icon name="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></lucide-icon>
              <p>Nenhum atendimento anterior encontrado</p>
            </div>
          } @else {
            <div class="overflow-y-auto max-h-96 pr-2">
              <!-- Timeline de Atendimentos -->
              <div class="relative">
                @for (atendimento of atendimentosAnteriores; track atendimento.id; let isLast = $last) {
                  <div class="flex gap-4 mb-6">
                    <!-- Linha do tempo -->
                    <div class="flex flex-col items-center">
                      <div class="w-3 h-3 rounded-full bg-primary flex-shrink-0 mt-1"></div>
                      @if (!isLast) {
                        <div class="w-0.5 h-full bg-base-300 flex-grow min-h-[2rem]"></div>
                      }
                    </div>

                    <!-- Conteúdo do atendimento -->
                    <div class="flex-1 pb-4">
                      <!-- Cabeçalho -->
                      <div class="mb-3">
                        <div class="flex items-center justify-between mb-1">
                          <div class="flex items-center gap-2">
                            <lucide-icon name="user-round" class="inline w-3 h-3 text-neutral"></lucide-icon>
                            <span class="font-semibold text-sm">{{ atendimento.profissional.nome }}</span>
                            @if (atendimento.tipoAtendimento) {
                              <span class="text-xs text-neutral">• {{ atendimento.tipoAtendimento }}</span>
                            }
                            <span class="text-xs text-neutral">{{ atendimento.data | date:'dd/MM/yyyy' }}</span>
                          </div>
                        </div>
                      </div>

                      <!-- Detalhes do atendimento -->
                      <div class="bg-base-100 rounded-lg border border-base-300 p-3 space-y-3 text-xs">
                        @if (atendimento.anamnese) {
                          <div>
                            <p class="font-semibold text-neutral mb-1">Anamnese</p>
                            <div class="prose prose-sm max-w-none text-xs" [innerHTML]="atendimento.anamnese"></div>
                          </div>
                        }

                        @if (atendimento.exameClinico) {
                          <div>
                            <p class="font-semibold text-neutral mb-1">Exame Clínico</p>
                            <div class="prose prose-sm max-w-none text-xs" [innerHTML]="atendimento.exameClinico"></div>
                          </div>
                        }

                        @if (atendimento.diagnostico) {
                          <div>
                            <p class="font-semibold text-neutral mb-1">Diagnóstico</p>
                            <div class="prose prose-sm max-w-none text-xs" [innerHTML]="atendimento.diagnostico"></div>
                          </div>
                        }

                        @if (atendimento.conduta) {
                          <div>
                            <p class="font-semibold text-neutral mb-1">Conduta</p>
                            <div class="prose prose-sm max-w-none text-xs" [innerHTML]="atendimento.conduta"></div>
                          </div>
                        }

                        @if (atendimento.observacoes) {
                          <div>
                            <p class="font-semibold text-neutral mb-1">Observações</p>
                            <div class="prose prose-sm max-w-none text-xs" [innerHTML]="atendimento.observacoes"></div>
                          </div>
                        }

                        @if (!atendimento.anamnese && !atendimento.exameClinico && !atendimento.diagnostico && !atendimento.conduta && !atendimento.observacoes) {
                          <p class="text-neutral italic text-center py-2">Nenhum detalhe registrado</p>
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        }
      </div>
    </div>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="mt-2" [ngClass]="{ 'visualizacao': readonly }">

      <div class="flex border-b border-base-300 mb-2">
        <button type="button"
          (click)="selecionarAba('anamnese')"
          class="px-4 py-2 text-sm font-medium transition-colors"
          [class]="abaAtiva === 'anamnese'
            ? 'border-b-2 border-primary text-primary'
            : 'text-neutral hover:text-base-content'">
          Anamnese
        </button>
        <button type="button"
          (click)="selecionarAba('exameFisico')"
          class="px-4 py-2 text-sm font-medium transition-colors"
          [class]="abaAtiva === 'exameFisico'
            ? 'border-b-2 border-primary text-primary'
            : 'text-neutral hover:text-base-content'">
          Exame Físico
        </button>
        <button type="button"
          (click)="selecionarAba('diagnostico')"
          class="px-4 py-2 text-sm font-medium transition-colors"
          [class]="abaAtiva === 'diagnostico'
            ? 'border-b-2 border-primary text-primary'
            : 'text-neutral hover:text-base-content'">
          Diagnóstico
        </button>
        <button type="button"
          (click)="selecionarAba('evolucaoClinica')"
          class="px-4 py-2 text-sm font-medium transition-colors"
          [class]="abaAtiva === 'evolucaoClinica'
            ? 'border-b-2 border-primary text-primary'
            : 'text-neutral hover:text-base-content'">
          Evolução Clínica
        </button>
        <button type="button"
          (click)="selecionarAba('examesSolicitados')"
          class="px-4 py-2 text-sm font-medium transition-colors"
          [class]="abaAtiva === 'examesSolicitados'
            ? 'border-b-2 border-primary text-primary'
            : 'text-neutral hover:text-base-content'">
          Exames Solicitados
        </button>
        <button type="button"
          (click)="selecionarAba('prescricoes')"
          class="px-4 py-2 text-sm font-medium transition-colors"
          [class]="abaAtiva === 'prescricoes'
            ? 'border-b-2 border-primary text-primary'
            : 'text-neutral hover:text-base-content'">
          Prescrições
        </button>
        <button type="button"
          (click)="selecionarAba('observacoes')"
          class="px-4 py-2 text-sm font-medium transition-colors"
          [class]="abaAtiva === 'observacoes'
            ? 'border-b-2 border-primary text-primary'
            : 'text-neutral hover:text-base-content'">
          Observações
        </button>
      </div>

      <div>
        <div *ngIf="abaAtiva === 'anamnese'" class="quill-editor w-full border-0">
          <quill-editor
            formControlName="anamnese"
            class="w-full"
            [modules]="readonly ? {} : quillModules"
            [styles]="{ height: '200px' }"
            [readOnly]="readonly"
            placeholder="">
          </quill-editor>
        </div>
        <div *ngIf="abaAtiva === 'exameFisico'" class="quill-editor w-full border-0">
          <quill-editor
            formControlName="exameFisico"
            class="w-full"
            [modules]="readonly ? {} : quillModules"
            [styles]="{ height: '200px' }"
            [readOnly]="readonly"
            placeholder="">
          </quill-editor>
        </div>
        <div *ngIf="abaAtiva === 'diagnostico'" class="quill-editor w-full border-0">
          <quill-editor
            formControlName="diagnostico"
            class="w-full"
            [modules]="readonly ? {} : quillModules"
            [styles]="{ height: '200px' }"
            [readOnly]="readonly"
            placeholder="">
          </quill-editor>
        </div>
        <div *ngIf="abaAtiva === 'evolucaoClinica'" class="quill-editor w-full border-0">
          <quill-editor
            formControlName="evolucaoClinica"
            class="w-full"
            [modules]="readonly ? {} : quillModules"
            [styles]="{ height: '200px' }"
            [readOnly]="readonly"
            placeholder="">
          </quill-editor>
        </div>
        <div *ngIf="abaAtiva === 'examesSolicitados'" class="quill-editor w-full border-0">
          <quill-editor
            formControlName="examesSolicitados"
            class="w-full"
            [modules]="readonly ? {} : quillModules"
            [styles]="{ height: '200px' }"
            [readOnly]="readonly"
            placeholder="">
          </quill-editor>
        </div>
        <div *ngIf="abaAtiva === 'prescricoes'" class="quill-editor w-full border-0">
          <quill-editor
            formControlName="prescricoes"
            class="w-full"
            [modules]="readonly ? {} : quillModules"
            [styles]="{ height: '200px' }"
            [readOnly]="readonly"
            placeholder="">
          </quill-editor>
        </div>
        <div *ngIf="abaAtiva === 'observacoes'" class="quill-editor w-full border-0">
          <quill-editor
            formControlName="observacoes"
            class="w-full"
            [modules]="readonly ? {} : quillModules"
            [styles]="{ height: '200px' }"
            [readOnly]="readonly"
            placeholder="">
          </quill-editor>
        </div>
      </div>

      <div class="flex mt-2">
        <div class="w-full">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-lg font-medium">Procedimentos Adicionais</h3>
          </div>

          <div class="rounded-t-lg">
            <div class="grid grid-cols-[3rem_1fr] gap-3 p-3 font-medium">
              <div>Qtd.</div>
              <div>Procedimento</div>
            </div>
          </div>

          <div class="space-y-1" formArrayName="procedimentos">
            <div *ngFor="let procedimento of procedimentosLancados.controls; let i = index" [formGroupName]="i"
                 class="grid grid-cols-[3rem_1fr] gap-3 items-center hover:bg-base-200 rounded-lg">

              <input [id]="'quantidade_' + i" type="number" min="1" formControlName="quantidade" class="campo mt-0 p-2" readonly>

              <ng-select [id]="'procedimento_' + i"  class="campo-select mt-0"
                         formControlName="procedimentoId"
                         placeholder="Selecione um procedimento"
                         [readonly]="true">
                @for (procedimento of procedimentos; track procedimento.id) {
                  <ng-option [value]="procedimento.id">{{procedimento.nome}}</ng-option>
                }
                <ng-template ng-notfound-tmp>
                  <span class="text-sm p-6">Nenhum resultado</span>
                </ng-template>
              </ng-select>
            </div>
          </div>
        </div>
      </div>

      <div class="flex justify-between mt-6">
        <button type="button" class="btn btn-sm" (click)="fechar()" >
          Fechar
        </button>
        <div>
          <button type="button" class="btn btn-primary btn-sm" *ngIf="podeEditar()" (click)="habilitarEdicao()">
            Continuar Atendimento
          </button>
          <button type="submit" class="btn btn-success btn-sm" *ngIf="modoSalvar">
            Finalizar Atendimento
          </button>
        </div>
      </div>
    </form>

  </div>
</div>

<!-- Layout de Impressão Modo Padrão -->
<div *ngIf="modoImpressao === 'padrao'" class="print-content print-modo-padrao">
  <div class="print-header">
    <h1>Registro de Atendimento Médico</h1>
    <p class="print-subtitle">Modo Padrão</p>
  </div>

  <div class="print-section">
    <h2>Informações do Paciente</h2>
    <div class="print-grid">
      <div class="print-field">
        <span class="print-label">Nome:</span>
        <span class="print-value">{{ agendamento?.paciente?.nome }}</span>
      </div>
      <div class="print-field">
        <span class="print-label">Data de Nascimento:</span>
        <span class="print-value">{{ agendamento?.paciente?.dataNascimento | date:'dd/MM/yyyy' }}</span>
      </div>
      <div class="print-field">
        <span class="print-label">Convênio:</span>
        <span class="print-value">{{ agendamento?.convenio?.nome || 'Particular' }}</span>
      </div>
      <div class="print-field">
        <span class="print-label">Data do Atendimento:</span>
        <span class="print-value">{{ atendimentoDetalhes?.data | date:'dd/MM/yyyy' }}</span>
      </div>
      <div class="print-field">
        <span class="print-label">Horário:</span>
        <span class="print-value">{{ atendimentoDetalhes?.horaInicio }} - {{ atendimentoDetalhes?.horaFim }}</span>
      </div>
    </div>
  </div>

  <div class="print-section" *ngIf="form.get('anamnese')?.value">
    <h2>Anamnese</h2>
    <div class="print-content-html" [innerHTML]="form.get('anamnese')?.value"></div>
  </div>

  <div class="print-section" *ngIf="form.get('exameFisico')?.value">
    <h2>Exame Físico</h2>
    <div class="print-content-html" [innerHTML]="form.get('exameFisico')?.value"></div>
  </div>

  <div class="print-section" *ngIf="form.get('diagnostico')?.value">
    <h2>Diagnóstico</h2>
    <div class="print-content-html" [innerHTML]="form.get('diagnostico')?.value"></div>
  </div>

  <div class="print-section" *ngIf="form.get('evolucaoClinica')?.value">
    <h2>Evolução Clínica</h2>
    <div class="print-content-html" [innerHTML]="form.get('evolucaoClinica')?.value"></div>
  </div>

  <div class="print-section" *ngIf="form.get('examesSolicitados')?.value">
    <h2>Exames Solicitados</h2>
    <div class="print-content-html" [innerHTML]="form.get('examesSolicitados')?.value"></div>
  </div>

  <div class="print-section" *ngIf="form.get('prescricoes')?.value">
    <h2>Prescrições</h2>
    <div class="print-content-html" [innerHTML]="form.get('prescricoes')?.value"></div>
  </div>

  <div class="print-section" *ngIf="form.get('observacoes')?.value">
    <h2>Observações</h2>
    <div class="print-content-html" [innerHTML]="form.get('observacoes')?.value"></div>
  </div>

  <div class="print-footer">
    <p>Documento gerado em {{ 'now' | date:'dd/MM/yyyy HH:mm' }}</p>
  </div>
</div>

<!-- Layout de Impressão Modo Alternativo -->
<div *ngIf="modoImpressao === 'alternativo'" class="print-content print-modo-alternativo">
  <div class="print-header-alt">
    <div class="print-header-left">
      <h1>Atendimento Médico</h1>
      <p class="print-date">{{ atendimentoDetalhes?.data | date:'dd/MM/yyyy' }} - {{ atendimentoDetalhes?.horaInicio }}</p>
    </div>
    <div class="print-header-right">
      <p class="print-label-alt">Modo Alternativo</p>
    </div>
  </div>

  <div class="print-patient-box">
    <div class="print-patient-row">
      <div class="print-patient-field">
        <strong>Paciente:</strong> {{ agendamento?.paciente?.nome }}
      </div>
      <div class="print-patient-field">
        <strong>DN:</strong> {{ agendamento?.paciente?.dataNascimento | date:'dd/MM/yyyy' }}
      </div>
    </div>
    <div class="print-patient-row">
      <div class="print-patient-field">
        <strong>Convênio:</strong> {{ agendamento?.convenio?.nome || 'Particular' }}
      </div>
      <div class="print-patient-field">
        <strong>Horário:</strong> {{ atendimentoDetalhes?.horaInicio }} - {{ atendimentoDetalhes?.horaFim }}
      </div>
    </div>
  </div>

  <div class="print-section-alt" *ngIf="form.get('anamnese')?.value">
    <h3>Anamnese</h3>
    <div class="print-content-html-alt" [innerHTML]="form.get('anamnese')?.value"></div>
  </div>

  <div class="print-section-alt" *ngIf="form.get('exameFisico')?.value">
    <h3>Exame Físico</h3>
    <div class="print-content-html-alt" [innerHTML]="form.get('exameFisico')?.value"></div>
  </div>

  <div class="print-section-alt" *ngIf="form.get('diagnostico')?.value">
    <h3>Diagnóstico</h3>
    <div class="print-content-html-alt" [innerHTML]="form.get('diagnostico')?.value"></div>
  </div>

  <div class="print-section-alt" *ngIf="form.get('evolucaoClinica')?.value">
    <h3>Evolução Clínica</h3>
    <div class="print-content-html-alt" [innerHTML]="form.get('evolucaoClinica')?.value"></div>
  </div>

  <div class="print-section-alt" *ngIf="form.get('examesSolicitados')?.value">
    <h3>Exames Solicitados</h3>
    <div class="print-content-html-alt" [innerHTML]="form.get('examesSolicitados')?.value"></div>
  </div>

  <div class="print-section-alt" *ngIf="form.get('prescricoes')?.value">
    <h3>Prescrições</h3>
    <div class="print-content-html-alt" [innerHTML]="form.get('prescricoes')?.value"></div>
  </div>

  <div class="print-section-alt" *ngIf="form.get('observacoes')?.value">
    <h3>Observações</h3>
    <div class="print-content-html-alt" [innerHTML]="form.get('observacoes')?.value"></div>
  </div>

  <div class="print-footer-alt">
    <hr/>
    <p>Gerado em {{ 'now' | date:'dd/MM/yyyy HH:mm' }}</p>
  </div>
</div>


<app-confirm-dialog
  *ngIf="exibeConfirmCancelamento"
  message="Você já preencheu algumas informações do atendimento, deseja realmente sair?"
  (confirm)="fechar(true)"
  (cancel)="exibeConfirmCancelamento = false"
></app-confirm-dialog>
