<div class="fixed inset-0 flex items-center justify-center bg-black/50 z-51">
  <div class="bg-white rounded-lg shadow-lg p-6 w-[58rem]"
    (click)="$event.stopPropagation()" >

    <h2 class="text-lg font-semibold mb-4">Novo Agendamento  </h2>

    <form [formGroup]="form" class="inline">

      <!-- LINHA 1 - DATA / HORÁRIO / PACIENTE / CONVÊNIO -->
      <div class="flex">
        <div class="w-[8rem] mr-4" >
          <label class="block font-medium text-gray-700">Data</label>
          <input type="date" formControlName="data" required
                 class="mt-1 p-1 block w-full rounded-md border border-gray-300"
                 [ngClass]="{'border-red-500': form.get('data')?.invalid && form.get('data')?.touched}" >
        </div>
        <div class="w-[4rem] mr-4">
          <label class="block font-medium text-gray-700">Horário</label>
          <input type="text" formControlName="hora" maxlength="5"
                 mask="00:00" emptyToNull class="mt-1 p-[5px] block w-full rounded-md border border-gray-300"
                 [ngClass]="{'border-red-500': form.get('hora')?.invalid && form.get('hora')?.touched}">
        </div>
        <div class="w-[24rem] mr-4" >
          <label class="block font-medium text-gray-700">Paciente</label>
          <ng-select formControlName="pacienteId" required class="mt-1 block w-full rounded-md" placeholder="Selecione o paciente"
                     [ngClass]="{'border border-red-500': form.get('pacienteId')?.invalid && form.get('pacienteId')?.touched}"
                     (change)="selectPaciente($event)" [items]="this.pacientes" bindValue="id" bindLabel="nome" >
            <ng-template ng-notfound-tmp>
              <div class="p-2 flex items-center justify-between gap-4">
                <div class="p-2 text-sm">
                  Paciente não encontrado.
                </div>
                <button (click)="mostrarFormularioNovoPaciente=true" class="ml-2 px-4 py-1 bg-green-500 text-white rounded-md hover:bg-green-600 flex items-center gap-2">
                  <lucide-icon name="plus" class="w-3 h-3"></lucide-icon>
                  Cadastrar
                </button>
              </div>
            </ng-template>
          </ng-select>
        </div>
        <div class="w-[16rem]">
          <label class="block font-medium text-gray-700">Convênio</label>
          <ng-select formControlName="convenioId" required class="mt-1 block w-full rounded-md" >
            @for (convenio of this.convenios; track convenio.id) {
              <ng-option [value]="convenio.id">{{convenio.nome}}</ng-option>
            }
          </ng-select>
        </div>
      </div>

      <!-- LINHA 2 - EMPRESA / PLANO EMPRESA -->
      <div class="flex mt-2">
        <div class="mr-4 w-[30rem]" >
          <label class="block font-medium text-gray-700">Empresa</label>
          <ng-select formControlName="empresaId" class="mt-1 block w-full rounded-md" (change)="selectEmpresa($event)" (clear)="selectEmpresa(undefined)" >
            @for (empresa of this.empresas; track empresa.id) {
              <ng-option [value]="empresa.id">{{empresa.nome}}</ng-option>
            }
          </ng-select>
        </div>

        <div class="w-[24rem]" >
          <label class="block font-medium text-gray-700" *ngIf="empresaSelecionada?.plano != null" >Plano Empresa</label>
          <div class="py-2 px-4 mt-1 text-sm italic rounded-md" [ngClass]="empresaSelecionada?.plano?.corFundo">{{ empresaSelecionada?.plano?.nome }}</div>
        </div>
      </div>

      <!-- LINHA 3 - ESPECIALIDADE / PROCEDIMENTO -->
      <div class="flex mt-2">
        <div class="mr-4 w-[26rem]" >
          <label class="block font-medium text-gray-700">Especialidade</label>
          <ng-select formControlName="especialidadeId" required class="mt-1 block w-full rounded-md" (change)="selectEspecialidade($event)">
            @for (especialidade of this.especialidades; track especialidade.id) {
              <ng-option [value]="especialidade.id">{{especialidade.nome}}</ng-option>
            }
          </ng-select>
        </div>

        <div class="w-[28rem]" >
          <label class="block font-medium text-gray-700">Procedimento</label>
          <ng-select formControlName="procedimentoId" class="mt-1 block w-full rounded-md"> <!-- FILTRAR POR ESPECIALIDADE -->
            @for (procedimento of this.procedimentos; track procedimento.id) {
              <ng-option [value]="procedimento.id">{{procedimento.nome}}</ng-option>
            }
          </ng-select>
        </div>

      </div>

      <!-- LINHA 4 - PROFISSIONAL -->
      <div class="flex mt-2">
        <div class="mr-4 w-[26rem]" >
          <label class="block font-medium text-gray-700">Profissional</label>
          <ng-select formControlName="profissionalId" required class="mt-1 block w-full rounded-md">
            @for (profissional of this.profissionaisFiltrados(); track profissional.id) {
              <ng-option [value]="profissional.id">{{profissional.nome}}</ng-option>
            }
          </ng-select>
        </div>

        <div class="w-[28rem]" >
          <label class="block font-medium text-gray-700">Outros campos</label>

        </div>

      </div>

      <div class="flex justify-end gap-3 mt-6">
        <button
          class="px-4 py-1 rounded-lg border border-gray-300 hover:bg-gray-100"
          (click)="onCancel()" >
          Cancelar
        </button>
        <button type="submit"
          class="px-4 py-1 rounded-lg bg-green-500 text-white hover:bg-green-600"
          (click)="onConfirm()" >
          Agendar
        </button>
      </div>
    </form>

  </div>

</div>

@if (mostrarFormularioNovoPaciente) {
  <app-paciente-form
    (save)="onSalvarNovoPaciente($event)"
    (cancel)="onCancelarNovo()"
  ></app-paciente-form>
}
